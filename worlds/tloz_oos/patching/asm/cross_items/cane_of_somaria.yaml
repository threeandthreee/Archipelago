46/4b67/parentItemCode_caneOfSomaria_46: /copy a,$06,$0b67,$1b

# itemCode04 at ages 07:5c49
47/5c49/itemCode04_47: /copy a,$07,$1c49,$63
# itemCode18 at ages 07:5cac
47/5cac/itemCode18_47: |
  /copy a,$07,$1cac,$13f
  
  push hl
  ld e,$46
  ld hl,getSomariaBlockIndex
  call interBankCall
  pop hl
  ld a,(hl)
  cp b
  
  /copy a,$07,$1dee,$0e
  
  call $15c5 ; getTileIndexFromRoomLayoutBuffer
  jp $3a52 ; setTile
  ; skip patch's room handling
  db $00,$00,$00,$00,$00
  
  /copy a,$07,$1e10,$2d
  jr c,$0d
  
  push hl
  ld e,$46
  ld hl,getSomariaBlockIndex
  call interBankCall
  pop hl
  ld a,(hl)
  ld (hl),b
  ld b,a
  
  /copy a,$07,$1e42,$18

# parentItemCode_caneOfSomaria adjustments
46/4b6f/: call $2aab ; updateLinkDirectionFromAngle

# itemCode04 adjustments
47/5c56/: ld a,$38; UNCMP_GFXH_AGES_1c > $38
47/5c58/: call $165b ; loadWeaponGfx
47/5c60/: call playSound
47/5c67/: jp $1e27 ; objectSetVisible82
47/5c70/: call $23a5 ; itemIncState
47/5c75/: call $2274 ; findItemWithID
47/5c90/: call $2c40 ; getFreeItemSlot

# itemCode18 adjustments
47/5cbd/: call $5e5c ; @alignOnTile
47/5cc7/: call $23a5 ; itemIncState
47/5ccc/: call playSound
47/5ccf/: jp $1e30 ; objectSetVisible83
47/5cd2/: call $5e10 ; @checkBlockCanAppear
47/5ced/: call $5e10 ; @checkBlockCanAppear
47/5d19/: call $23aa ; itemIncSubState
47/5d1c/: call $2c37 ; itemUpdateAngle
# 47/5d22/: ld a,(wBraceletLevel) TODO : when bracelet 2 is implemented, change that
47/5d22/: |
  ld a,$01
  nop
47/5d34/: call playSound
47/5d37/: call $5dfe ; @removeBlock
47/5d44/: call $1fdb ; objectApplySpeed
47/5d4a/: call $2391 ; itemDecCounter1
47/5d56/: call $5dfe ; @removeBlock
47/5d5e/: call $24ad ; objectCreatePuff
47/5d61/: jp $2c29 ; itemDelete
47/5d70/: call $23aa ; itemIncSubState
47/5d73/: call $5dfe ; @removeBlock
47/5d76/: call $1dfa ; objectSetVisiblec1
47/5d82/: call $2b8a ; dropLinkHeldItem
47/5d87/: call $215d ; objectCheckWithinRoomBoundary
47/5dae/: ld a,($ccb3) ; (wActiveTilePos)
47/5db6/: ld a,($cc50) ; (wTilesetFlags)
47/5dcc/: jp z,$2b75 ; objectAddToGrabbableObjectBuffer
47/5dd1/: jp $29c5 ; itemSetState
47/5de2/: jp $1d3d ; preventObjectHFromPassingObjectD

47/5e18/: call $149b ; objectGetTileCollisions
47/5e1c/: ld a,($cc50) ; (wTilesetFlags)
47/5e2f/: |
  call $5e5c ; @alignOnTile
  call $1432 ; objectGetTileAtPosition
47/5e36/: |
  ld hl,$23c3 ; hazardCollisionTable
  call $1ddd ; lookupCollisionTable

47/5e55/: call $1414 ; setTileInRoomLayoutBuffer
47/5e5c/: call $2099 ; objectCenterOnTile

06//parentItemCode_caneOfSomaria: |
  ld hl,parentItemCode_caneOfSomaria_46
  call_bank_46:
  ld e,$46
  jp interBankCall

07//itemCode04: |
  ld hl,itemCode04_47
  call_bank_47:
  ld e,$47
  jp interBankCall

07//itemCode18: |
  ld hl,itemCode18_47
  jr call_bank_47

# Update parentItemUpdate table
06/49af/: dw parentItemCode_caneOfSomaria

07/48b2/: dw itemCode04
07/48da/: dw itemCode18

# Update item usage table
06/5510/: db $03

# nextToPushableBlock with somaria block
06/413b/: |
  ld e,$46
  ld hl,nextToPushableBlock_checkSomaria
  jp interBankCall
  nop
  nop
  ld h,$d1

46/4141/nextToPushableBlock_checkSomaria: |
  call getSomariaBlockIndex
  ldh a,($8b)
  cp b
  /copy a,$06,$0145,$0e
  ld e,$06
  ld hl,$4145
  jp interBankCall

46/4174/: |
  @end_call:
  ld e,$06
  ld hl,$415e
  jp interBankCall
  @end:
  jr @end_call

46/4180/@somariaBlock: |
  /copy a,$06,$017e,$13
46/4182/: call $2274
46/418b/: ld a,($cc80) ; (wLinkPushingDirection)

# tryToBreakTile_body, close to @doneSettingTile
06/4777/: |
  ld e,$46
  ld hl,tryToBreakTile_body@doneSettingTile
  call interBankCall
  jp (hl)
  nop

46/47a0/tryToBreakTile_body@doneSettingTile: |
  call getSomariaBlockIndex
  ldh a,($92)
  cp b
  /copy a,$06,$07a6,$0a
  ld hl,$4781
  ret

46/47b3/getSomariaBlockIndex: |
  ld a,($cc4f) ; wActiveCollisions
  ld b,$3f ; Overworld
  or a
  ret z
  dec a ; Subrosia
  ld b,$ba
  ret z
  dec a ; Maku Tree (2)
  ld b,$3f
  ret z
  ; Indoors (3), Dungeon (4), Sidescrolling (5)
  ld b,$f9
  ret

46/47e6/tryToBreakTile_body@done: |
  ld hl,$47b8
  ret
  /copy a,$06,$07ea,$1f

46/47ec/: call $2274 ; findItemWithID
46/47ef/: jr nz,$f5 ; move @done backwards to fit a ld hl
46/47f4/: call $227b ; findItemWithID_startingAfterH
46/47f7/: jr nz,$ed ; move @done backwards to fit a ld hl
46/47fc/: jr $e8 ; move @done backwards to fit a ld hl

# edit somaria block interactableTilesTable
06/43a5/: |
  dw interactableTilesTable@subrosia
  dw $43c1
  dw $43c7
  dw $43c7
  dw $43c1
06/43c1/: db $3f,$80,$00,$00,$00,$00,$f9,$80
06//interactableTilesTable@subrosia: |
  /copy s,$06,$03c2,$06
  db $ba,$80,$00

# edit breakableTileCollisionTable
06/75c2/: |
  dw $7645
  dw $75ce
  dw $76b6
  dw $76b6
  dw $76e7

06/7642/: |
  ; overworld / maku
  db $3f,$30
  db $0
  
  ; subrosia
  db $ba,$30
  /copy s,$06,$3643,$6f
  
  ; indoors / dungeons
  db $f9,$30
  /copy s,$06,$36b2,$2f
  
  ; sidescrolling
  db $f9,$30
  /copy s,$06,$36e1,$03

  ; breakableTileModes
  /copy s,$06,$36e4,$f0
  /copy a,$06,$39d7,$05 ; add collision $30

# move breakableTileModes reference
06/4734/: db $ec

# Change sndMysterySeed priority
39/55cc/sndMysterySeed: db $32

# clearAllItemsAndPutLinkOnGround
00//clearSomariaBlock: |
  /copy a,$00,$19bc,$05
  jr nz,@notSomariaBlock
  /copy a,$00,$19c3,$0a
  ret
  @notSomariaBlock:
  /copy a,$00,$19cf,$03
  call $044b ; clearMemory
  ret

00/1995/: |
  call clearSomariaBlock
  nop
  nop
  nop

# Make somaria cane not cut grass
# To do that, only cut grass when it's a sword instead of not cutting it when it's the rod
07/5d50/: |
  cp $05
  db $20 ; replaces jr z by jr nz

# Remove the grass effect on the somaria block indoors
00/0f39/: |
  call checkSomariaGrass
  jr c,$10 ; @end
00//checkSomariaGrass: |
  cp $f9
  jr nz,@end
  ld a,(wActiveGroup)
  cp $02
  ccf
  ret c

  @end:
  and a ; sets c to 0
  bit 2,h
  ld a,($cc52) ; wGrassAnimationModifier
  ret

# gfx
# inv icon
1b/7ac0/: /copy a,$19,$42e0,$20
# Apply the sprite to the inventory item by changing the treasureDisplayData
3f/6dbe/: db $a5
# Add the gfx entry to the interactionData
3f/67f6/: db $61,$0a,$20 ; GFX_5e
# TreasureDisplayData
3f/6dc3/: db text.cane.inventory
# treasureObjectData
15/513b/: db text.cane.treasure,$5e
